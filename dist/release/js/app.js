(function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);return e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype,b},c=function(a,b){return function(){return a.apply(b,arguments)}};window.Kankan={module:function(){var a;return a={},function(b){return a[b]?a[b]:a[b]={Views:{}}}}(),fetchTemplate:function(a,b){return window.JST==null&&(window.JST={}),JST[a]?b(JST[a]):$.get(a,function(c){var d;return d=_.template(c),JST[a]=d,b(d)})},app:_.extend({},Backbone.Events)},$(function(){var a,c,d,e,f,g,h;return g=Kankan.app,c=Kankan.module("example"),d=Kankan.module("login"),a=Kankan.module("boards"),f=Kankan.module("session"),h=Kankan.session=new f.Model,e=function(c){function e(){e.__super__.constructor.apply(this,arguments)}return b(e,c),e.prototype.routes={"":"login",login:"login",example:"example"},e.prototype.initialize=function(){return this.boardsRouter=new a.Router},e.prototype.login=function(){var a;return h.isAuthorised()?Backbone.history.navigate("boards",!0):(a=new d.Views.Login,a.render())},e.prototype.logout=function(){return h.destroy()},e}(Backbone.Router),g.router=new e,Backbone.history.start({pushState:!0}),$(document).on("click","a:not([data-bypass])",function(a){var b,c;b=$(this).attr("href"),c=this.protocol+"#";if(b.slice(0,c.length)!==c)return a.preventDefault(),g.router.navigate(b,!0)}),$.ajaxSetup({headers:{"X-Requested-With":"XMLHttpRequest"}})}),function(a){var d,e,f;return f=Kankan.app,d=Kankan.module("cards"),e=Kankan.module("lanes"),a.Model=function(a){function c(){c.__super__.constructor.apply(this,arguments)}return b(c,a),c}(Backbone.Model),a.Collection=function(c){function d(){d.__super__.constructor.apply(this,arguments)}return b(d,c),d.prototype.model=a.Model,d.prototype.url=function(){return"http://localhost:3000/api/v1/boards"},d}(Backbone.Collection),a.Router=function(c){function f(){f.__super__.constructor.apply(this,arguments)}return b(f,c),f.prototype.routes={boards:"index","boards/:id":"show"},f.prototype.boards=new a.Collection,f.prototype.index=function(){var b;if(Kankan.session.enforceAuthorisation())return b=new a.Views.Index({collection:this.boards})},f.prototype.show=function(b){var c,f,g,h,i;c=this.boards.get(b);if(Kankan.session.enforceAuthorisation())return h=new e.Collection(null,{boardId:b}),f=new d.Collection(null,{boardId:b}),i=new a.Views.Show({model:c,collection:h}),g=new a.Views.CardsList({model:c,collection:f},h)},f}(Backbone.Router),a.Views.Index=function(a){function c(){c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.template="/app/templates/boards/index.html",c.prototype.events={"click .board_link":"showBoard"},c.prototype.initialize=function(){var a;return a=this.collection,a.bind("reset",this.render,this),a.bind("add",this.render,this),a.bind("remove",this.render,this),a.fetch()},c.prototype.render=function(){var a;return a=this,Kankan.fetchTemplate(this.template,function(b){return $(a.el).html(b({boards:a.collection.models})),$("#main").html(a.el)})},c.prototype.showBoard=function(a){return a.preventDefault(),Backbone.history.navigate("boards/"+$(a.target).attr("data-board-id"),!0)},c}(Backbone.View),a.Views.Show=function(a){function c(){c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.template="/app/templates/boards/show.html",c.prototype.initialize=function(){var a;return a=this.collection,a.bind("reset",this.render,this),a.bind("add",this.render,this),a.bind("remove",this.render,this),a.fetch()},c.prototype.render=function(){var a;return a=this,Kankan.fetchTemplate(this.template,function(b){return $(a.el).html(b({board:a.model,lanes:a.collection.models})),$("#main").html(a.el),this.$("#cardModal").modal({backdrop:!0,keyboard:!0}),f.trigger("kankan.lanes.rendered")})},c}(Backbone.View),a.Views.CardsList=function(d){function e(){this.showCard=c(this.showCard,this),this.createCard=c(this.createCard,this),e.__super__.constructor.apply(this,arguments)}return b(e,d),e.prototype.template="/app/templates/boards/cardModal.html",e.prototype.initialize=function(a,b){var c,d;return this.lanes=b,c=this.collection,c.bind("reset",this.addAll,this),c.bind("add",this.addOne,this),d=this,f.bind("kankan.lanes.rendered",function(){return $("form").on("submit",d.createCard),$(".board").on("click",".card",d.showCard),c.fetch()})},e.prototype.addAll=function(){return this.collection.each(this.addOne)},e.prototype.addOne=function(b){var c;return c=new a.Views.Card({model:b}),c.render(function(a){return this.$("#lane_"+b.get("lane_id")).append(a)})},e.prototype.createCard=function(a){var b;return a.preventDefault(),b=this.collection.create({title:$("#cardTitle").val(),lane_id:this.lanes.first().id}),$("#cardTitle").val(""),b},e.prototype.showCard=function(a){var b,c;return c=$(a.target).attr("data-card-id"),b=this.collection.get(c),Kankan.fetchTemplate(this.template,function(a){return this.$("#cardModal .modal-contents").html(a({card:b})),this.$("#cardModal").modal("show")})},e}(Backbone.View),a.Views.Card=function(a){function c(){c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.template="/app/templates/boards/card.html",c.prototype.initialize=function(){return this.model.bind("change",this.render,this),this.model.bind("destroy",this.remove,this)},c.prototype.render=function(a){var b;return b=this,Kankan.fetchTemplate(this.template,function(c){return $(b.el).html(c({card:b.model})),a(b.el)})},c.prototype.addOne=function(){var a=this;return Kankan.fetchTemplate(this.cardTemplate,function(a){})},c}(Backbone.View)}(Kankan.module("boards")),function(a){var c;return c=Kankan.app,a.Model=function(a){function c(){c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.url=function(){return"http://localhost:3000/api/v1/cards"},c}(Backbone.Model),a.Collection=function(c){function d(){d.__super__.constructor.apply(this,arguments)}return b(d,c),d.prototype.model=a.Model,d.prototype.initialize=function(a,b){return this._meta={},this.meta("boardId",b.boardId)},d.prototype.url=function(){return"http://localhost:3000/api/v1/cards/for_board?board_id="+this.meta("boardId")},d.prototype.meta=function(a,b){return b==null?this._meta[a]:this._meta[a]=b},d}(Backbone.Collection)}(Kankan.module("cards")),function(a){var c;return c=Kankan.app,a.Model=function(a){function c(){c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.url=function(){return"http://localhost:3000/api/v1/lanes"},c}(Backbone.Model),a.Collection=function(c){function d(){d.__super__.constructor.apply(this,arguments)}return b(d,c),d.prototype.model=a.Model,d.prototype.initialize=function(a,b){return this._meta={},this.meta("boardId",b.boardId)},d.prototype.url=function(){return"http://localhost:3000/api/v1/lanes?board_id="+this.meta("boardId")},d.prototype.meta=function(a,b){return b==null?this._meta[a]:this._meta[a]=b},d}(Backbone.Collection)}(Kankan.module("lanes")),function(a){var c;return c=Kankan.app,a.Views.Login=function(a){function c(){c.__super__.constructor.apply(this,arguments)}return b(c,a),c.prototype.template="app/templates/login.html",c.prototype.events={"submit form":"login"},c.prototype.render=function(){var a;return a=this,Kankan.fetchTemplate(this.template,function(b){return $(a.el).html(b()),$("#main").html(a.el)})},c.prototype.login=function(a){var b,c,d;return d=this,a.preventDefault(),b=this.$("input[name=email]").val(),c=this.$("input[name=password]").val(),Kankan.session.authenticate(b,c,function(a){return a?console.log("login error",a):(Kankan.session.addHeaderToAjaxCalls(),Backbone.history.navigate("boards",!0))})},c}(Backbone.View)}(Kankan.module("login")),function(a){var b,c,d;return c=Kankan.app,b=function(){function a(){this.store=localStorage.getItem(this.storeId),this.data=this.store&&JSON.parse(this.store)||{}}return a.prototype.storeId="sessions",a.prototype.key="currentUser",a.prototype.save=function(){return localStorage.setItem(this.storeId,JSON.stringify(this.data))},a.prototype.create=function(a){return this.data[this.key]=a,this.save(),a},a.prototype.update=function(a){return this.data[this.key]=a,this.save(),a},a.prototype.retrieve=function(){return this.data[this.key]},a.prototype.destroy=function(a){return delete this.data[this.key],this.save(),a},a}(),d=new b,a.Model=function(){function a(){var a;a=d.retrieve(),a?(this.email=a.email,this.token=a.token,this.addHeaderToAjaxCalls()):(this.email="",this.token="")}return a.prototype.authenticate=function(a,b,c){var d;return d=this,d.getTokenFromApi(a,b,function(a){return a?c.call(d,a):c.call(d)})},a.prototype.isAuthorised=function(){if(this.token)return!0;if(this.email){this.getTokenFromLocalStorage();if(this.token)return!0}return!1},a.prototype.enforceAuthorisation=function(){return this.isAuthorised()?!0:(Backbone.history.navigate("login",!0),!1)},a.prototype.getTokenFromLocalStorage=function(){var a;a=d.retrieve();if(a.token)return this.token=a.token,d.update(this)},a.prototype.getTokenFromApi=function(a,b,c){var e;return e=this,$.ajax({type:"POST",url:"http://localhost:3000/api/v1/tokens.json",data:{email:a,password:b},success:function(a){return a.status==="ok"?(e.email=a.user.email,e.token=a.user.authentication_token,d.create(e),c.call(e)):c.call(e,"Login failed")},error:function(a,b,d){return c.call(e,"Login error")},dataType:"json"})},a.prototype.addHeaderToAjaxCalls=function(){return $.ajaxSetup({headers:{"X-Requested-With":"XMLHttpRequest"},beforeSend:function(a,b){var c;return c=/\?/.test(b.url)?"&":"?",b.url+=""+c+"auth_token="+Kankan.session.token}})},a.prototype.destroy=function(){return d.destroy(this),this.email="",this.token=""},a}()}(Kankan.module("session"))}).call(this)